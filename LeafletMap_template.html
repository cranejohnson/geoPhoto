
<!DOCTYPE html>
<html>
<head>

	<title>GeoJSON tutorial - Leaflet</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">


    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css" type="text/css" media="screen" />


    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.css"/>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>

    <script src="https://unpkg.com/esri-leaflet@2.0.8"></script>
    <script src="https://azavea.github.io/Leaflet.zoomdisplay/js/leaflet.zoomdisplay.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.3/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.1/proj4leaflet.min.js"></script>
    <script src="https://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>

	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		img {
		  width:100%;
      //height:100%;
      object-fit: cover;
      overflow: hidden;
    }
		#container {
      width: 1200px;
      background-color: #ffcc33;
      margin: auto;
    }
		#mapid {
			width: 500px;
			height: 500px;
			float:left
		}
		#imageBox{
		  width:640px;
		  height:500px;
		  float:left
		}
	</style>


</head>
<body>
<center>
<h3>APRFC Photo Viewer</h3>
<i>Use the <strong>left</strong> and <strong>right</strong> arrow keys, click a point on the map or use the buttons below to view photos</i><br>
<button id="back"> Previous Photo </button><button id="forward"> Next Photo </button>  <input type="checkbox" id="autoPan" checked ><label for="autoPan"> Auto Pan Enabled</label><br>
</center>

<div id='container'>
    <div id='mapid'></div>
    <div id='imageBox'>
        <span id='photoInfo'></span>
        <a id="aImg" class="image-popup-vertical-fit" href="" title=""><img id="aImgview" src=""></a>
    </div>
<div>
<script>



  //var photoPoints =  <GEOJSON _ PHOTOS>;

  var photoPoints = <GEOJSON_PHOTOS>;

  var displayImageNo = -1;

  var avgLat = 0;
  var avgLng = 0;
  var numGeoTag = 0;
  var theMarker = {};


  //Get the average lat/lon of the photos
  for(var i=0; i<photoPoints.features.length; i++){
      var lat = photoPoints.features[i].geometry.coordinates[1];
      var lng = photoPoints.features[i].geometry.coordinates[0];
      if (lat > 0){
        avgLat = avgLat + lat;
        avgLng = avgLng + lng;
        numGeoTag = numGeoTag +1;
      }
  }
  avgLat = avgLat/numGeoTag;
  avgLng = avgLng/numGeoTag;


  //setup leaflet base layers
  var esriTopo = L.esri.basemapLayer("Topographic");
  var usgsTopo =   L.esri.tiledMapLayer({
    url: "https://services.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer"
  });
  var worldTerrain  =  L.tileLayer( "https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}" );
  var Esri_WorldImagery = L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");

  var oceanLayer    =  L.tileLayer( "https://txgeo.usgs.gov/arcgis/rest/services/Mapping/Ocean/MapServer/tile/{z}/{y}/{x}",{"maxNativeZoom":11} );
  var hydroTerrain  =  L.tileLayer( "https://txgeo.usgs.gov/arcgis/rest/services/Mapping/HydroBaseMapForTerrain/MapServer/tile/{z}/{y}/{x}",{"maxNativeZoom":11} );
  var hydroMask     =  L.tileLayer( "https://txgeo.usgs.gov/arcgis/rest/services/Mapping/Mask/MapServer/tile/{z}/{y}/{x}", {"opacity":0.2,"maxNativeZoom":11} );
  var hydroBase = L.layerGroup([worldTerrain, hydroTerrain, hydroMask]);


	map = new L.Map("mapid",{
	  keyboard: false,
    "layers"  : [Esri_WorldImagery,esriTopo,usgsTopo,hydroBase],
    "attributionControl" : false,
    "center" : new L.LatLng(63,-147.45),
    "zoom"   : 9
	});


  var baseMaps = {
    "World Imagery" : Esri_WorldImagery,
    "Topography" : esriTopo,
    "USGS Maps" : usgsTopo,
    "Hydrography" : hydroBase,
  };

  map.createPane('labels');
  map.getPane('labels').style.zIndex = 650;
  map.getPane('labels').style.pointerEvents = 'none';


  var wmsCityLayer = L.tileLayer.wms('http://tiles1.dnr.alaska.gov/service?', {
    layers: 'dnr:MV_TOWN_L',
    transparent: true,
    pane: 'labels'
  }).addTo(map);

  var wmsPlacesLayer = L.tileLayer.wms('http://tiles1.dnr.alaska.gov/service?', {
    layers: 'dnr:MV_USGS_PLACE_NAMES_L',
    transparent: true,
    pane: 'labels'
  });



  var mapControl = L.control.layers(baseMaps,null).addTo(map);

  mapControl.addOverlay(wmsCityLayer,"Cities and Towns");
  mapControl.addOverlay(wmsPlacesLayer,"USGS Place Names");

  var coordsDisplay = L.control.coordinates(
      {labelTemplateLat:"Lat: {y}",
    labelTemplateLng:"Lon: {x}"}).addTo(map);


 //  $('.leaflet-container').css('cursor','crosshair');
//   L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
// 		maxZoom: 18,
// 		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
// 			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
// 			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
// 		id: 'mapbox/light-v9',
// 		tileSize: 512,
// 		zoomOffset: -1
// 	}).addTo(map);




	var photoGroup = L.geoJSON(photoPoints, {

		style: function (feature) {
			return feature.properties && feature.properties.style;
		},


		pointToLayer: function (feature, latlng) {

		  if(latlng['lng'] ==0){
        return L.circleMarker([avgLat,avgLng], {
          GPS: false,
          radius: 0,
          opacity: 0,
          fillOpacity: 0
        });
		  }
			return L.circleMarker(latlng, {
			  GPS: true,
				radius: 4,
				fillColor: "orange",
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.8
			});
		}
	}).addTo(map);


	map.fitBounds(photoGroup.getBounds());

  function showImage(layer){
    $("#aImgview").attr("src",layer.feature.properties.Path);
    $("#aImg").attr("href",layer.feature.properties.Path);
    $("#aImg").attr("title","Taken: "+layer.feature.properties.Datetime+"<br/>\nFile:"+layer.feature.properties.Path);
    $("#photoInfo").html(
      "Photo Number: "+(layer.feature.properties.order+1)+"<br><strong>EXIF information</strong><br>Date Taken: "+layer.feature.properties.Datetime+"<br>Lat: "+layer.feature.geometry.coordinates[1]+" Lon: "+layer.feature.geometry.coordinates[0]+"<br>Photo Direction: "+layer.feature.properties.bearing+" Degrees<br>File name: "+layer.feature.properties.Path);



    if (theMarker != undefined) {
          map.removeLayer(theMarker);
    };

    if((layer.options.GPS == true) && ($('#autoPan').is(":checked"))){
      map.flyTo(layer._latlng)
    }

    //Add a marker to show where you clicked.
    if((layer.options.GPS == true)&& (layer.feature.properties.bearing != null)){
      theMarker = L.marker(layer._latlng, {
          rotationAngle: layer.feature.properties.bearing+15
          //rotationOrigin: 'center center'
      }).addTo(map);
    }

  }





  $(document).ready(function() {


    $('.image-popup-vertical-fit').magnificPopup({
      type: 'image',
      closeOnContentClick: true,
      mainClass: 'mfp-img-mobile',
      image: {
          verticalFit: true
      },
      zoom: {
          enabled: true, // By default it's false, so don't forget to enable it

          duration: 300, // duration of the effect, in milliseconds
          easing: 'ease-in-out', // CSS transition easing function

          // The "opener" function should return the element from which popup will be zoomed in
          // and to which popup will be scaled down
          // By defailt it looks for an image tag:
          opener: function(openerElement) {
            // openerElement is the element on which popup was initialized, in this case its <a> tag
            // you don't need to add "opener" option if this code matches your needs, it's defailt one.
            return openerElement.is('img') ? openerElement : openerElement.find('img');
          }
        }
    });
  });

  function nextPhoto(upDown){
        displayImageNo = displayImageNo + upDown;

        if(displayImageNo < 0){
          displayImageNo = photoGroup.getLayers().length+upDown;
        }
        if(displayImageNo == photoGroup.getLayers().length){
          displayImageNo = 0;
        }

        photoGroup.eachLayer(function(layer) {
          if(layer.feature.properties.order == displayImageNo ){
            showImage(layer);
            layer.setStyle({
              'fillColor': 'blue',
              'radius'   : 8
            });
          }
          else{
            layer.setStyle({
              'fillColor': 'orange',
              'radius'   : 4
            });

          }

          //layer.bindPopup(layer.feature.properties.name);
        });


  }


  photoGroup.on({
    click: function(e) {
      displayImageNo = e.layer.feature.properties.order;

      showImage(e.layer);

      e.target.setStyle({
        'fillColor': 'orange',
        'radius'   : 4
      });
      e.layer.setStyle({
         'fillColor': 'blue',
         'radius'   : 8
       });
    }

  });

  $( "#back" ).click(function() {
    nextPhoto(-1);
  });

  $( "#forward" ).click(function() {
    nextPhoto(1);
  });

  $(document).keydown(function(e) {
     if(e.keyCode == 39){
        e.preventDefault();
        nextPhoto(1);
      }
     if(e.keyCode == 37){
        e.preventDefault();
        nextPhoto(-1);
     }
  });

</script>



</body>
</html>
